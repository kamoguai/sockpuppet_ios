# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

# api_key = app_store_connect_api_key(
#   key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
#   issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
#   key_filepath: ENV['API_KEY_PATH'],
# )

platform :ios do
  desc "Push a new beta build to TestFlight"
  lane :beta do
    # increment_build_number(xcodeproj: "SSGaming.xcodeproj")
    build_app(workspace: "SSGaming.xcworkspace", scheme: "SSGaming")
    # upload_to_testflight
  end

  lane :build_and_sign do
    # åŒæ­¥è­‰æ›¸å’Œæè¿°æ–‡ä»¶
      match(
        type: "appstore", # å¯é¸ï¼šdevelopment, adhoc, enterprise, appstore
        readonly: true
      )

      # ä½¿ç”¨è‡ªå‹•ç®¡ç†ç°½å
      build_app(
        scheme: "SSGaming",               # æ›¿æ›ç‚ºä½ çš„schemeåç¨±
        export_method: "app-store",            # é€™è£¡å¯ä»¥æ ¹æ“šéœ€è¦é¸æ“‡ app-store, ad-hoc, enterprise, development
        export_xcargs: "-allowProvisioningUpdates", # å…è¨±Xcodeè‡ªå‹•æ›´æ–°æè¿°æ–‡ä»¶
        xcargs: "-allowProvisioningUpdates" # ç¢ºä¿åœ¨æ§‹å»ºéç¨‹ä¸­ä½¿ç”¨é€™å€‹é¸é …
      )
  end

  lane :tests do
    run_tests(workspace: "SSGaming.xcworkspace",
            devices: ["iPhone 8 (15.0)"],
            scheme: "SSGaming")
  end

  # desc "dowload certificates from the git"
  # lane :syncCertificates do
  #   match(
  #      api_key: api_key,
  #      type: "development",
  #      git_basic_authorization: Base64.strict_encode64(ENV["GIT_AUTHORIZATION"]),
  #      keychain_password: ENV["MATCH_PASSWORD"]
  #      )
  # end

  # desc "Connect App Store connect by API"
  # lane :connectByAPI do
  #   app_store_connect_api_key(
  #     key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
  #     issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
  #     key_filepath: ENV['API_KEY_PATH'],
  #   )
  # end

  desc "Build and archive APP"
  lane :archive do
    # update_code_signing_settings(
    #   path: "#{ENV['SCHEME']}.xcodeproj",
    #   team_id:ENV["DEVELOPER_PORTAL_TEAM_ID"],
    #   targets: ENV["SCHEME"],
    #   code_sign_identity: ENV["APP_DISTRIBUTION"],
    #   profile_name: "#{profileName}",
    #   bundle_identifier: ENV["APP_IDENTIFIER"]
    # )

    build_app(
      workspace: "#{ENV['SCHEME']}.xcworkspace",
      scheme: ENV["SCHEME"],
      export_method: "development",
      clean: true,
      output_directory: './build',
      output_name: "#{fileName}",
      # xcargs: 'DEBUG_INFORMATION_FORMAT=dwarf-with-dsym'

    )
  end

  private_lane :profileName do
    "#{ENV['BUNDLE_ID']} AppStore"
  end
  private_lane :fileName do
    versionNumber = get_version_number(target: ENV["SCHEME"])
    "#{ENV["SCHEME"]}_#{versionNumber}.ipa"
  end

  desc "response echo"
  lane :hello do
    puts "echo echo"
  end

  desc "Update Bundle Name and App Name"
  private_lane :update_names do |options|
    puts "@@@@ enter update name function @@@@"
    plist_path = "/Users/kamoguai/Desktop/é¦¬ç”²æ–‡ä»¶/sockpuppet-ios/SSGaming/Info.plist"
    proj_path = "/Users/kamoguai/Desktop/é¦¬ç”²æ–‡ä»¶/sockpuppet-ios/SSGaming.xcodeproj"
    bundle_id = get_info_plist_value(
      path: plist_path,
      key: "BundleID"
    )
    puts "bundle_id => #{bundle_id}"
    # bundle_name = options[:bundle_name]
    app_name = options[:app_name]
    bundle_identifier = options[:bundle_identifier]
    host_name = options[:host_name]
    puts "inputField app_name : #{app_name}"
    puts "inputField bundle_identifier : #{bundle_identifier}"
    puts "inputField host_name : #{bundle_identifier}"
    # ä½¿ç”¨PlistBuddyæ›´æ–°Info.plist
    # sh "/usr/libexec/PlistBuddy -c \"Set :CFBundleName #{bundle_name}\" #{plist_path}"
    sh "/usr/libexec/PlistBuddy -c \"Set :CFBundleDisplayName #{app_name}\" #{plist_path}"
    sh "/usr/libexec/PlistBuddy -c \"Set :HostName #{host_name}\" #{plist_path}"
    # sh "/usr/libexec/PlistBuddy -c \"Set :CFBundleIdentifier #{bundle_identifier}\" #{plist_path}"
    # ä½¿ç”¨ sed ä¿®æ”¹ project.pbxproj æ–‡ä»¶ä¸­çš„ Bundle Identifier
    sh "sed -i '' 's/PRODUCT_BUNDLE_IDENTIFIER = #{bundle_id};/PRODUCT_BUNDLE_IDENTIFIER = #{bundle_identifier};/' #{proj_path}/project.pbxproj"
    sh "/usr/libexec/PlistBuddy -c \"Set :BundleID #{bundle_identifier}\" #{plist_path}"
    # æ‰“å°ä¿®æ”¹åçš„ Bundle Identifier ç¡®è®¤
    sh "grep -A 1 'PRODUCT_BUNDLE_IDENTIFIER' #{proj_path}/project.pbxproj"#{proj_path}/project.pbxproj
  end

  desc "Deploy to TestFlight with updated names"
  lane :gama do |options|
    # æ›´æ–°åç¨±
    update_names(bundle_name: options[:bundle_name], app_name: options[:app_name], bundle_identifier: options[:bundle_identifier], host_name: options[:host_name])
  end

  # =======================================
  # ======= Download Certificates =========
  # =======================================

  desc "Download Development Certificates And Profiles"
  lane :download_development_certificates do
    match_for_all(account_type: "development", readonly: true)
  end

  desc "Download Distribution Certificates And Profiles"
  #readonly ç‚º false æœƒå»ºç«‹æ–°çš„æ†‘è­‰ï¼Œtrue å‰‡ä¸æœƒ
  lane :download_distribution_certificates do
    match_for_all(account_type: "appstore", readonly: true)
  end

  private_lane :match_for_all do |options|
    account_type = options[:account_type]
    readonly = options[:readonly]
    # force_for_new_devices => æœ‰æ–°è£ç½®æ™‚æœƒé‡æ–°ç”Ÿæˆ provisioning profile
    match(type: account_type,
    force_for_new_devices: true,
    readonly: readonly)
  end
  # =======================================
  # ======= Build ipa to local file =======
  # =======================================
   desc "build dev"
   lane :dev_beta do
  	# é€é match åŒæ­¥æ†‘è­‰
    	download_development_certificates
  	# é€é gym æ‰“åŒ… ipa
   	build(build_type: 'development', ipa_name: 'DEV')
    	# åœ¨ macOS é€šçŸ¥æ¬„ç™¼é€é€šçŸ¥
   	notification(subtitle: "æ‰“åŒ…å®Œæˆ", message: "å·²ç¶“æ‰“åŒ…åœ¨æœ¬åœ°äº†")
   end

   desc "release to app-store"
   lane :release_beta do
  	download_distribution_certificates
  	build(build_type: 'adhoc', ipa_name: 'Release')
   end

   private_lane :build do |options|
  	build_number = Time.new.strftime("%y%m%d%H%M")
  	build_type = options[:build_type]
  	ipa_name = ENV["SCHEME"] + "-" + options[:ipa_name]
  	configure = build_type == 'development' ? 'Debug': 'Release'

  	puts "app build ğŸ„ğŸ„ğŸ„"
  	puts "build_type: " + build_type
  	puts "build_number: " + build_number
  	puts "ipa_name: " + ipa_name

  	increment_build_number(build_number: build_number)
  	gym(clean: true,
  		configuration: configure,
  		scheme: ENV["SCHEME"],
  		export_method: build_type,
  		output_directory: ENV["EXPORT_OUTPUT_DIRECTORY"],#ipaè¼¸å‡ºä½ç½®
  		output_name: ipa_name,#ipaåç¨±
          silent:true#éš±è—æ²’æœ‰å¿…è¦çš„è³‡è¨Š
          )

   end

   desc "replace appIcon & splash icon "
   lane :replace_icons do |options|
     app_icon_dir = options[:app_icon] || "../../appIcon"
     launch_image_dir = options[:launch_image] || "../../launchImage"

     # æ‰¾åˆ°ç›®éŒ„ä¸­çš„ç¬¬ä¸€å€‹ PNG æ–‡ä»¶
     app_icon_path = Dir.glob(File.join(app_icon_dir, "*.png")).first
     if app_icon_path.nil?
       UI.user_error!("No app icon found in #{app_icon_dir}")
     end

     appicon(
       appicon_image_file: app_icon_path,
       appicon_devices: [:ipad, :iphone, :ios_marketing, :watch, :watch_marketing],
       appicon_path: "/Users/kamoguai/Desktop/é¦¬ç”²æ–‡ä»¶/sockpuppet-ios/SSGaming/Assets.xcassets"
     )

      # æ‰¾åˆ°ç›®éŒ„ä¸­çš„ç¬¬ä¸€å€‹ PNG æ–‡ä»¶
      launch_image_path = Dir.glob(File.join(launch_image_dir, "*.png")).first
      puts " --- launch_image_path first file : #{launch_image_path} --- "
      if launch_image_path.nil?
        UI.user_error!("No app launch image found in #{launch_image_dir}")
      end

      launch_image_sets = {
       "LaunchImage" => {
         "images" => [
           {
             "idiom" => "universal",
             "filename" => File.basename(launch_image_path),
             "scale" => "1x"
           },
           {
             "idiom" => "universal",
             "scale" => "2x"
           },
           {
             "idiom" => "universal",
             "scale" => "3x"
           }
           # æ·»åŠ å…¶ä»–å¿…è¦çš„å°ºå¯¸å’Œé…ç½®
         ],
         "info" => {
           "version" => 1,
           "author" => "xcode"
         }
       }
      }

      launch_image_sets.each do |name, data|
        puts "for each launch_image_path file #{name}"
        # å°‡ launch_image_path æ–‡ä»¶è¤‡è£½åˆ°å°æ‡‰çš„ç›®éŒ„
        target_launch_image_dir = "/Users/kamoguai/Desktop/é¦¬ç”²æ–‡ä»¶/sockpuppet-ios/SSGaming/Assets.xcassets/#{name}.imageset/"
        FileUtils.cp(launch_image_path, target_launch_image_dir)
        File.open("/Users/kamoguai/Desktop/é¦¬ç”²æ–‡ä»¶/sockpuppet-ios/SSGaming/Assets.xcassets/#{name}.imageset/Contents.json", "w") do |f|
          f.write(JSON.pretty_generate(data))
        end
      end
   end

   desc "Release Testing: Build and distribute the app for testing"
   lane :release_testing do
    puts "@@@ fastlane action release_testing is start @@@"
    # ç¡®ä¿ä½¿ç”¨ Ad Hoc é…ç½®æ–‡ä»¶
    match(
      type: "adhoc",
      app_identifier: "com.webapp.testBuild",
      readonly: false,  # ç¡®ä¿ Match å¯ä»¥åˆ›å»ºæ–°è¯ä¹¦å’Œé…ç½®æ–‡ä»¶
      keychain_name: "login.keychain",
      keychain_password: "0000"
    )

    # æ„å»ºå’Œæ‰“åŒ…åº”ç”¨
    gym(
      clean: true,
      scheme: "SSGaming",
      configuration: "Release",
      export_method: "ad-hoc",
      output_directory: "./build",
      output_name: "build.ipa",
      include_bitcode: false,
      include_symbols: false
    )

    # è¿è¡Œæµ‹è¯•
    # scan(
    #   scheme: "SSGaming",
    #   device: "iPhone 11",
    #   configuration: "Release",
    #   clean: true
    # )
  end
end
